<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>St. Louis Bike Routing</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1;
            max-width: 300px;
        }
        
        button {
            background: #3887be;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
        }
        
        button:hover {
            background: #2c6b9f;
        }
        
        #info {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        
        .legend {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 3px;
            margin-right: 10px;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div id="controls">
    <h3>ðŸš´ St. Louis Bike Router</h3>
    
    <button onclick="findRandomRoute('fastest')">Find Fastest Route</button>
    <button onclick="findRandomRoute('safest')">Find Safest Route (Avoid Hills)</button>
    <button onclick="toggleTerrain()">Toggle 3D Terrain</button>
    
    <div id="info"></div>
    
    <div class="legend">
        <strong>Route Colors:</strong>
        <div class="legend-item">
            <div class="legend-color" style="background: #00ff00;"></div>
            <span>Flat (0-2%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffff00;"></div>
            <span>Gentle (2-5%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff8800;"></div>
            <span>Moderate (5-8%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff0000;"></div>
            <span>Steep (8%+)</span>
        </div>
    </div>
</div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2Vtb2hhciIsImEiOiJjbWhwY3dkcmcwbTNiMmpwdzd0cnV5cXY1In0.1n9GIqBhItV0TqrMSTePAg';
    
    // Initialize map
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/outdoors-v12',
        center: [-90.1994, 38.6270], // St. Louis
        zoom: 12,
        pitch: 45,  // Tilt for 3D effect
        bearing: 0
    });
    
    let terrainEnabled = false;
    let currentRoute = null;
    let mapLoaded = false;
    
    // Add navigation controls
    map.addControl(new mapboxgl.NavigationControl());
    
    // Add 3D terrain when map loads
    map.on('load', function() {
        // Add terrain source
        map.addSource('mapbox-dem', {
            'type': 'raster-dem',
            'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
            'tileSize': 512,
            'maxzoom': 14
        });
        
        // Add sky
        map.addLayer({
            'id': 'sky',
            'type': 'sky',
            'paint': {
                'sky-type': 'atmosphere',
                'sky-atmosphere-sun': [0.0, 0.0],
                'sky-atmosphere-sun-intensity': 15
            }
        });
    });

    mapLoaded = true;
    console.log('Map loaded, terrain source added');
    
    function toggleTerrain() {
        if (!mapLoaded) {
            alter('Map still loading, please wait...');
            return;
        }

        if (terrainEnabled) {
            map.setTerrain(null);
            map.setPitch(0);
            terrainEnabled = false;
            console.log('Terrain disabled')
        } else {
            map.setTerrain({ 
                'source': 'mapbox-dem', 
                'exaggeration': 2  // Exaggerate hills for visibility
            });
            map.setPitch(60);
            terrainEnabled = true;
            console.log('Terrain enabled')
        }
    }
    
    async function findRandomRoute(routeType) {
        document.getElementById('info').innerHTML = 'Finding route...';
        
        try {
            // Get two random nodes
            const nodesResponse = await fetch('http://localhost:5001/api/nodes/random');
            const nodes = await nodesResponse.json();
            
            if (nodes.length < 2) {
                alert('Could not find suitable nodes');
                return;
            }
            
            const startNode = nodes[0].id;
            const endNode = nodes[1].id;
            
            // Get route
            const routeResponse = await fetch(
                `http://localhost:5001/api/route?start=${startNode}&end=${endNode}&type=${routeType}`
            );
            const routeGeoJSON = await routeResponse.json();
            
            if (routeGeoJSON.error) {
                document.getElementById('info').innerHTML = 'No route found';
                return;
            }
            
            // Remove old route
            if (map.getLayer('route')) {
                map.removeLayer('route');
                map.removeSource('route');
            }
            
            // Add route to map with color based on grade
            map.addSource('route', {
                'type': 'geojson',
                'data': routeGeoJSON
            });
            
            map.addLayer({
                'id': 'route',
                'type': 'line',
                'source': 'route',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'grade_percent'],
                        -10, '#0000ff',  // Downhill: blue
                        0, '#00ff00',     // Flat: green
                        2, '#ffff00',     // Gentle: yellow
                        5, '#ff8800',     // Moderate: orange
                        8, '#ff0000'      // Steep: red
                    ],
                    'line-width': 6
                }
            });
            
            // Calculate route stats
            let totalDistance = 0;
            let totalClimb = 0;
            let totalDescent = 0;
            
            routeGeoJSON.features.forEach(feature => {
                totalDistance += feature.properties.length_m;
                const elevChange = feature.properties.elevation_change_m;
                if (elevChange > 0) totalClimb += elevChange;
                if (elevChange < 0) totalDescent += Math.abs(elevChange);
            });
            
            // Fit map to route
            const coordinates = routeGeoJSON.features.flatMap(
                f => f.geometry.coordinates
            );
            const bounds = coordinates.reduce((bounds, coord) => {
                return bounds.extend(coord);
            }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
            
            map.fitBounds(bounds, {
                padding: 50,
                duration: 1000
            });
            
            // Display info
            document.getElementById('info').innerHTML = `
                <strong>${routeType === 'fastest' ? 'Fastest' : 'Safest'} Route</strong><br>
                Distance: ${(totalDistance / 1000).toFixed(2)} km<br>
                Total Climb: ${totalClimb.toFixed(0)} m<br>
                Total Descent: ${totalDescent.toFixed(0)} m<br>
                Segments: ${routeGeoJSON.features.length}
            `;
            
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('info').innerHTML = 'Error finding route';
        }
    }
</script>

</body>
</html>